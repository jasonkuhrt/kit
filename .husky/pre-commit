#!/usr/bin/env sh

# Check if there are staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  # No staged files, nothing to do
  exit 0
fi

# Stash unstaged changes (keeping index intact)
# This handles partial staging - unstaged changes are safely stashed
STASH_NAME="pre-commit-$(date +%s)"
git stash push --keep-index --include-untracked -m "$STASH_NAME" > /dev/null 2>&1
STASH_CREATED=$?

# Format the staged files
pnpm fix:format

# Re-stage the formatted files (only what was originally staged)
echo "$STAGED_FILES" | xargs git add

# Restore unstaged changes if we created a stash
if [ $STASH_CREATED -eq 0 ]; then
  git stash pop --index > /dev/null 2>&1
fi

# Always succeed (never block commit)
exit 0
